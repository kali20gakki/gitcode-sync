name: Batch sync GitCode → GitHub

on:
  schedule:
    # 每天 UTC 03:00 跑一次
    - cron: '0 3 * * *'
  workflow_dispatch:   # 手动触发

env:
  GITCODE_TOKEN: ${{ secrets.GITCODE_TOKEN }}
  TARGET_ORG: kali20gakki          # 想推到的 GitHub 用户/组织
  # 下面写你要同步的 GitCode 仓库清单（可无限加）
  REPOS: |
    Ascend/msprof
    Ascend/msprof-analyze

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sync repo（只为了用 bash 环境）
        uses: actions/checkout@v4

      - name: Setup git
        run: |
          git config --global user.name  "gitcode-sync-bot"
          git config --global user.email "sync@example.com"

      - name: Sync all repos
        shell: bash
        run: |
          set -e
          mapfile -t repos <<< "$REPOS"
          for repo in "${repos[@]}"; do
            [[ -z "$repo" ]] && continue
            echo "==== Syncing $repo ===="
            GITCODE_URL="https://oauth2:${GITCODE_TOKEN}@gitcode.com/${repo}.git"
            GITHUB_URL="https://x-access-token:${{ secrets.GH_PAT }}@github.com/${TARGET_ORG}/${repo##*/}.git"

            # 裸克隆
            git clone --mirror "$GITCODE_URL" repo.git
            cd repo.git

            # 1. 强制推送所有分支、标签（不会尝试删除）
            git push --force --all "$GITHUB_URL"
            git push --force --tags "$GITHUB_URL"

            # 2. 如果远端有 main 且本地没有，则删除它
            #    （master 已推送成功，GitHub 允许删非默认分支）
            if git ls-remote --heads "$GITHUB_URL" refs/heads/main | grep -q main; then
              # 把默认分支临时换成 master，再删 main，然后立即换回来
              gh api repos/${TARGET_ORG}/${repo##*/} \
                 --method PATCH \
                 --field default_branch=master \
                 --header "Authorization: token ${{ secrets.GH_PAT }}"
              git push --delete "$GITHUB_URL" main || true
              gh api repos/${TARGET_ORG}/${repo##*/} \
                 --method PATCH \
                 --field default_branch=master \
                 --header "Authorization: token ${{ secrets.GH_PAT }}"
            fi

            cd ..
            rm -rf repo.git
          done